name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install mise and toolchain
        uses: jdx/mise-action@v2

      - name: Build and package release artifacts
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${GITHUB_REF_NAME#v}"
          if [[ "${VERSION}" == "${GITHUB_REF_NAME}" ]]; then
            echo "Expected a v-prefixed tag, got: ${GITHUB_REF_NAME}" >&2
            exit 1
          fi

          mkdir -p release-assets release-stage

          build_and_package() {
            local zig_target="$1"
            local asset_suffix="$2"
            local archive_format="$3"
            local out_dir="dist/${zig_target}"
            local binary_name="wt"
            local package_dir="release-stage/wt_${VERSION}_${asset_suffix}"

            if [[ "${zig_target}" == *windows* ]]; then
              binary_name="wt.exe"
            fi

            echo "Building ${zig_target}"
            mise x -- zig build \
              -Dtarget="${zig_target}" \
              -Doptimize=ReleaseSafe \
              -Dapp_version="${VERSION}" \
              -p "${out_dir}"

            mkdir -p "${package_dir}"
            cp "${out_dir}/bin/${binary_name}" "${package_dir}/"

            if [[ "${archive_format}" == "zip" ]]; then
              (
                cd release-stage
                zip -q -r "../release-assets/wt_${VERSION}_${asset_suffix}.zip" "wt_${VERSION}_${asset_suffix}"
              )
            else
              tar -C release-stage \
                -czf "release-assets/wt_${VERSION}_${asset_suffix}.tar.gz" \
                "wt_${VERSION}_${asset_suffix}"
            fi
          }

          build_and_package "x86_64-linux" "linux_x86_64" "tar.gz"
          build_and_package "aarch64-linux" "linux_arm64" "tar.gz"
          build_and_package "aarch64-macos" "macos_arm64" "tar.gz"
          build_and_package "x86_64-macos" "macos_x86_64" "tar.gz"
          build_and_package "x86_64-windows" "windows_x86_64" "zip"

          dist/x86_64-linux/bin/wt --version | grep -Eq "^wt ${VERSION} "

          (
            cd release-assets
            sha256sum wt_* > SHA256SUMS
          )

          sed "s/{{VERSION}}/${GITHUB_REF_NAME}/g" .github/release-notes-template.md > release-assets/RELEASE_NOTES.md

      - name: Publish GitHub release
        shell: bash
        run: |
          set -euo pipefail

          gh release create "${GITHUB_REF_NAME}" \
            --verify-tag \
            --title "wt ${GITHUB_REF_NAME}" \
            --notes-file release-assets/RELEASE_NOTES.md \
            release-assets/wt_* \
            release-assets/SHA256SUMS
