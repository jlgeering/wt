[tools]
zig = "0.15"
"github:Dicklesworthstone/beads_rust" = "latest"

[tasks.build]
description = "Build debug binary for current platform"
run = "zig build"

[tasks.test]
description = "Run unit tests"
run = "zig build test"

[tasks.format]
description = "Format Zig source files"
run = "zig fmt build.zig src test"

[tasks.lint]
description = "Check Zig formatting"
run = "zig fmt --check build.zig src test"

[tasks.run]
description = "Build and run wt with passthrough args"
run = "zig build run -- {{arg(rest=true)}}"

[tasks."build:release"]
description = "Build release binary for current platform"
run = "zig build -Doptimize=ReleaseSafe"

[tasks."build:all"]
description = "Cross-compile for macOS, Linux, and Windows"
depends = ["build:mac", "build:linux", "build:windows"]

[tasks."build:windows"]
description = "Build for Windows x86_64"
run = "zig build -Dtarget=x86_64-windows -Doptimize=ReleaseSafe -p dist/x86_64-windows"

[tasks."build:mac"]
description = "Build for macOS arm64 + x86_64"
run = """
zig build -Dtarget=aarch64-macos -Doptimize=ReleaseSafe -p dist/aarch64-macos
zig build -Dtarget=x86_64-macos -Doptimize=ReleaseSafe -p dist/x86_64-macos
"""

[tasks."build:linux"]
description = "Build for Linux x86_64 + aarch64"
run = """
zig build -Dtarget=x86_64-linux -Doptimize=ReleaseSafe -p dist/x86_64-linux
zig build -Dtarget=aarch64-linux -Doptimize=ReleaseSafe -p dist/aarch64-linux
"""

[tasks.check]
description = "Run formatting, tests, and build (pre-commit check)"
depends = ["lint", "test", "build"]

[tasks.release]
description = "Cut and publish a release (usage: mise run release -- <X.Y.Z>)"
usage = '''
arg "<release_version>"
'''
run = """
RELEASE_VERSION="$usage_release_version" mise run release:pipeline
"""

[tasks."release:pipeline"]
description = "Internal release DAG root"
hide = true
depends = ["release:gh:verify-latest"]

[tasks."release:validate"]
description = "Validate release preconditions and prepare notes/staging"
hide = true
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
STAGE_ROOT="dist/release/$TAG"
rm -rf "$STAGE_ROOT"
mkdir -p "$STAGE_ROOT/build" "$STAGE_ROOT/dist"
mise x -- zig run src/tools/release.zig -- validate --version "$usage_release_version"
mise x -- zig run src/tools/release.zig -- extract-notes --version "$usage_release_version" --out "$STAGE_ROOT/notes.md"
"""

[tasks."release:build:mac"]
description = "Build release binaries for macOS"
hide = true
depends = ["release:validate"]
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
BUILD_ROOT="dist/release/$TAG/build"
zig build -Dtarget=aarch64-macos -Doptimize=ReleaseSafe -Dapp_version="$usage_release_version" -p "$BUILD_ROOT/aarch64-macos"
zig build -Dtarget=x86_64-macos -Doptimize=ReleaseSafe -Dapp_version="$usage_release_version" -p "$BUILD_ROOT/x86_64-macos"
"""

[tasks."release:build:linux"]
description = "Build release binaries for Linux"
hide = true
depends = ["release:validate"]
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
BUILD_ROOT="dist/release/$TAG/build"
zig build -Dtarget=x86_64-linux -Doptimize=ReleaseSafe -Dapp_version="$usage_release_version" -p "$BUILD_ROOT/x86_64-linux"
zig build -Dtarget=aarch64-linux -Doptimize=ReleaseSafe -Dapp_version="$usage_release_version" -p "$BUILD_ROOT/aarch64-linux"
"""

[tasks."release:build:windows"]
description = "Build release binaries for Windows"
hide = true
depends = ["release:validate"]
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
BUILD_ROOT="dist/release/$TAG/build"
zig build -Dtarget=x86_64-windows -Doptimize=ReleaseSafe -Dapp_version="$usage_release_version" -p "$BUILD_ROOT/x86_64-windows"
"""

[tasks."release:build"]
description = "Run preflight checks and build all release binaries"
hide = true
depends = ["check", "release:build:mac", "release:build:linux", "release:build:windows"]

[tasks."release:package"]
description = "Verify host artifact and package release archives + checksums"
hide = true
depends = ["release:build"]
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
BUILD_ROOT="dist/release/$TAG/build"
DIST_DIR="dist/release/$TAG/dist"
mise x -- zig run src/tools/release.zig -- verify-host --version "$usage_release_version" --build-root "$BUILD_ROOT"
mise x -- zig run src/tools/release.zig -- package --version "$usage_release_version" --build-root "$BUILD_ROOT" --dist-dir "$DIST_DIR"
mise x -- zig run src/tools/release.zig -- verify-checksums --dist-dir "$DIST_DIR"
"""

[tasks."release:git"]
description = "Push main and release tag"
hide = true
depends = ["release:package"]
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
git push github main
git tag -a "$TAG" -m "wt $TAG"
git push github "$TAG"
"""

[tasks."release:gh:create-draft"]
description = "Create draft GitHub release with required assets"
hide = true
depends = ["release:git"]
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
STAGE_ROOT="dist/release/$TAG"
DIST_DIR="$STAGE_ROOT/dist"
NOTES_FILE="$STAGE_ROOT/notes.md"
mise x -- gh release create "$TAG" \
  "$DIST_DIR/wt-$TAG-darwin-arm64.tar.gz" \
  "$DIST_DIR/wt-$TAG-darwin-amd64.tar.gz" \
  "$DIST_DIR/wt-$TAG-linux-arm64.tar.gz" \
  "$DIST_DIR/wt-$TAG-linux-amd64.tar.gz" \
  "$DIST_DIR/wt-$TAG-windows-amd64.zip" \
  "$DIST_DIR/SHA256SUMS" \
  --repo "jlgeering/wt" \
  --verify-tag \
  --title "wt $TAG" \
  --notes-file "$NOTES_FILE" \
  --draft
"""

[tasks."release:gh:verify-draft"]
description = "Verify draft release state and contents"
hide = true
depends = ["release:gh:create-draft"]
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
DRAFT_STATE="$(mise x -- gh release view "$TAG" --repo "jlgeering/wt" --json isDraft --jq '.isDraft')"
if [ "$DRAFT_STATE" != "true" ]; then
  echo "error: release is not draft before publish gate" >&2
  exit 1
fi
ASSET_COUNT="$(mise x -- gh release view "$TAG" --repo "jlgeering/wt" --json assets --jq '.assets | length')"
if [ "$ASSET_COUNT" -ne 6 ]; then
  echo "error: expected 6 release assets, found $ASSET_COUNT" >&2
  exit 1
fi
BODY_LEN="$(mise x -- gh release view "$TAG" --repo "jlgeering/wt" --json body --jq '.body | length')"
if [ "$BODY_LEN" -le 0 ]; then
  echo "error: release notes body is empty" >&2
  exit 1
fi
"""

[tasks."release:gh:publish"]
description = "Publish release and mark latest"
hide = true
depends = ["release:gh:verify-draft"]
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
mise x -- gh release edit "$TAG" --repo "jlgeering/wt" --draft=false --latest
"""

[tasks."release:gh:verify-latest"]
description = "Verify latest release points at published tag"
hide = true
depends = ["release:gh:publish"]
usage = '''
arg "<release_version>" env="RELEASE_VERSION"
'''
run = """
TAG="v$usage_release_version"
LATEST_TAG="$(mise x -- gh api 'repos/jlgeering/wt/releases/latest' --jq '.tag_name')"
if [ "$LATEST_TAG" != "$TAG" ]; then
  echo "error: latest release is $LATEST_TAG, expected $TAG" >&2
  exit 1
fi
RELEASE_URL="$(mise x -- gh release view "$TAG" --repo 'jlgeering/wt' --json url --jq '.url')"
echo "Release published: $RELEASE_URL"
"""

[tasks.clean]
description = "Remove build artifacts"
run = "rm -rf zig-out/ .zig-cache/ dist/"

[tasks.install]
description = "Build release and install to ~/.local/bin/wt"
depends = ["build:release"]
run = """
mkdir -p ~/.local/bin
cp zig-out/bin/wt ~/.local/bin/wt
"""
